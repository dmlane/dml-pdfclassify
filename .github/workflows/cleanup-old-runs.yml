- name: Authenticate and Delete Workflow Runs Older Than 30 Days
  env:
    GH_TOKEN: ${{ secrets.HOMEBREW_TAP_PAT }}
  on:
    schedule:
      - cron: '0 0 * * 0'  # Every Sunday at 00:00 UTC
    workflow_dispatch:     # Allows manual runs from GitHub UI
  run: |
    REPO="${{ github.repository }}"
    echo "Cleaning up runs for $REPO older than 30 days..."
    gh auth status
    gh run list --repo "$REPO" --limit 1000 --json databaseId,createdAt,status | \
      jq -c '.[] | select(.status != "in_progress" and (.createdAt | fromdateiso8601 < (now - 30*86400))) | .databaseId' | \
      xargs -r -I % gh run delete % --repo "$REPO" --yes

